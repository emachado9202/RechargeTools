@model IEnumerable<RechargeTools.Models.Catalog.Agent>
@{
    ViewBag.Title = "Números";
}
@section css{

    @Styles.Render("~/Content/table")
}
<input type="hidden" value="@ViewBag.number_search" id="number_search" />
<div class="row">
    <div class="col-12">
        <ul class="nav nav-pills" id="myTab" role="tablist">
            @foreach (var agent in Model)
            {
                <li class="nav-item">
                    <a class="nav-link @(agent.Selected ? "active": "")" id="tab-@agent.Id" data-toggle="tab" data-value="@agent.Id" href="#content-@agent.Id" role="tab" aria-controls="content-@agent.Id" aria-selected="@agent.Selected">@agent.Name</a>
                </li>
            }
        </ul>
        <div class="tab-content" id="myTabContent">
            @foreach (var agent in Model)
            {
                <div class="tab-pane fade @(agent.Selected ? "show active": "")" id="content-@agent.Id" role="tabpanel" aria-labelledby="tab-@agent.Id" data-value="@agent.Id">
                </div>
            }
        </div>
        <div class="pull-right btn-editions">

            <a class="btn-copy btn btn-success btn-sm ml-lg-1" href="javascript:copy_numbers();">Copiar Números</a>
        </div>
        <table id="data-table" class="table table-striped table-bordered" width="100%">
            <thead>
                <tr>
                    <th>Número</th>
                    <th>Confirmación</th>
                    <th class="no-sort">Usuario</th>
                    <th>Creado</th>
                    <th>Actualizado</th>
                    <th class="no-sort"></th>
                </tr>
            </thead>
        </table>
    </div>
</div>
<div class="row" id="form_lot">
    <div class="col">
        <h2 class="text-center">Insertar Lote</h2>
        <p class="text-muted text-center">
            Insertar uno por línea
        </p>
        <div class="form-horizontal">
            <div class="form-group">
                <textarea class="w-100 form-control" inputmode="verbatim"></textarea>
                <p class="text-danger" style="display:none;">Estos números no pudieron insertarse porque contienen error</p>
            </div>
            <div class="form-group text-center">
                <a class="btn btn-dark" href="javascript:register_numbers();">Registrar</a>
            </div>
        </div>
    </div>
</div>
<textarea type="text" id="numbers_to_clipboard" class="opacity-0"></textarea>

@section scripts{

    @Scripts.Render("~/bundles/table")

    <script type="text/javascript">
        $(document).ready(function () {
            register_numbers = function () {
                $("#form_lot textarea").addClass("disabled");
                $("#form_lot textarea").attr("disabled", "true");
                $("#form_lot .btn-dark").addClass("disabled");
                $("#form_lot p.text-danger").hide();

                $.ajax({
                    type: 'POST',
                    data: {
                        recharge_id: '@ViewBag.Recharge.Id',
                        agent_id: $("#myTabContent .show.active").data("value"),
                        data: $("#form_lot textarea").val()
                    },
                    url: "/Home/AddNumbers",
                    dataType: 'json',
                    success: function (data) {
                        $("#form_lot textarea").removeClass("disabled");
                        $("#form_lot textarea").removeAttr("disabled");
                        $("#form_lot .btn-dark").removeClass("disabled");
                        table.ajax.reload();
                        $("#form_lot textarea").val(data);
                        if (data !== "") {
                            $("#form_lot p.text-danger").show();
                        }
                    }
                });
            };

            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                $.ajax({
                    type: 'POST',
                    data: {
                        agent_id: $(e.target).data("value")
                    },
                    url: "/Home/AgentSelect",
                    dataType: 'json',
                    success: function (data) {
                        table.ajax.reload();
                    }
                });
            });

            var editor;

            editor = new $.fn.dataTable.Editor({
                ajax: "/Home/Edit",
                table: "#data-table",
                fields: [{
                    label: "Number:",
                    name: "number"
                }, {
                    label: "Confirmation:",
                    name: "confirmation"
                }
                ],
                formOptions: {
                    inline: {
                        onBlur: 'submit'
                    }
                }
            });

            // Activate an inline edit on click of a table cell
            $('#data-table').on('click', 'tbody td:not(:last-child)', function (e) {
                if ($(this).next().length != 0) {
                    editor.inline(this);
                }
            });

            var table = $("#data-table").DataTable({
                dom: "lBfrtip",
                responsive: 1,
                select: 0,
                fixedHeader: !0,
                ajax: {
                    "url": "/Home/Search",
                    "type": "POST",
                    "data": function (d) {
                        d.type = $("#myTabContent .show.active").data("value")
                    }
                },
                "processing": true,
                "serverSide": true,
                columns: [
                    { data: "number" },
                    { data: "confirmation" },
                    { data: "user" },
                    { data: "created_date" },
                    { data: "updated_date" },
                    {
                        "render": function (data, type, JsonResultRow, meta) {
                            var actions = "";
                            if (JsonResultRow.number !== '' && JsonResultRow.number !== null) {
                                actions += '<a class=\'btn btn-danger btn-sm\' href=\'javascript:delete_row("' + JsonResultRow.DT_RowId + '");\'>Eliminar</a><br />';
                            }
                            return actions;
                        }
                    }
                ],
                "rowCallback": function (row, data) {
                    /* mainView.contents.push(new dataModel(data));*/
                },
                "iDisplayLength": 25,
                "language": {
                    "sProcessing": "Procesando...",
                    "sLengthMenu": "Mostrar _MENU_ registros",
                    "sZeroRecords": "No se encontraron resultados",
                    "sEmptyTable": "Ningún dato disponible en esta tabla",
                    "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "sInfoPostFix": "",
                    "sSearch": "Buscar:",
                    "sUrl": "",
                    "sInfoThousands": ",",
                    "sLoadingRecords": "Cargando...",
                    "oPaginate": {
                        "sFirst": "Primero",
                        "sLast": "Último",
                        "sNext": "Siguiente",
                        "sPrevious": "Anterior"
                    },
                    "oAria": {
                        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                    },
                    "select": {
                        "rows": "%d registros seleccionados"
                    }
                },
                "columnDefs": [{
                    "targets": 'no-sort',
                    "orderable": false
                }],
                "order": [[3, "desc"]],
                select: {
                    style: 'os',
                    selector: 'td:first-child'
                },
                buttons: []
            });

            delete_row = function (id) {
                $.ajax({
                    type: 'POST',
                    data: {
                        id: id
                    },
                    url: "/Home/Delete",
                    dataType: 'json',
                    success: function (data) {
                        table.ajax.reload();
                    }
                });
            }
            $("#data-table_filter input").val($("#number_search").val());
            $("#data-table_filter input").keyup();

            copy_numbers = function () {
                var value = "";
                table.rows().every(function (index, element) {
                    var data = this.data();
                    if (data.number != null && data.confirmation == null) {
                        value += data.number + "\n";
                    }
                });
                $("#numbers_to_clipboard").val(value);
                var copyText = document.getElementById("numbers_to_clipboard");
                copyText.select();
                copyText.setSelectionRange(0, 99999);
                document.execCommand("copy");
            }

        });
    </script>
}